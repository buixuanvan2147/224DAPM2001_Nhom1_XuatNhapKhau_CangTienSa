@{
    ViewBag.Title = "Tra Cứu Đơn Hàng";
}

<main style="min-height: calc(100vh - 160px); padding-top:0;">
    <div class="container mt-5" style="margin-top: 3rem !important;">
        @if (!string.IsNullOrEmpty(ViewBag.ErrorMessage))
        {
            <div class="alert alert-danger mt-4" role="alert" style="margin-top: 1.5rem !important; background-color: #f8d7da !important; border-color: #f5c6cb !important; color: #721c24 !important; padding: 0.75rem 1.25rem !important; border: 1px solid transparent !important; border-radius: 0.25rem !important; display: flex; align-items: center;">
                <i class="fas fa-exclamation-triangle" style="margin-right: 0.5rem;"></i> @((string)(ViewBag.ErrorMessage))
            </div>
        }

        @if (ViewBag.DonHang != null)
        {
            <div class="mt-4 p-4 border rounded shadow-sm" style="margin-top: 1.5rem !important; padding: 1.5rem !important; border: 1px solid #ced4da !important; border-radius: 0.25rem !important; box-shadow: 0 .125rem .25rem rgba(0,0,0,.075) !important;">
                <h2 style="margin-bottom: 1rem !important;">Tra Cứu Đơn Hàng Khác</h2>
                <div class="input-group" style="display: flex;">
                    <input type="text" id="maDonHangTiepTheo" class="form-control border-light" style="padding: 15px; border-color: #ced4da !important; border-radius: 0.25rem 0 0 0.25rem; flex-grow: 1;" placeholder="Nhập Mã Đơn Hàng Khác">
                    <div class="input-group-append" style="margin-left: 0;">
                        <button id="btnTraCuuTiepTheo" class="btn btn-primary px-3" style="background-color: #007bff !important; border-color: #007bff !important; border-radius: 0 0.25rem 0.25rem 0; color: #fff; transition: background-color 0.15s ease-in-out, border-color 0.15s ease-in-out; display: flex; align-items: center;">
                            <i class="fas fa-search" style="margin-right: 0.3rem;"></i> Tra Cứu
                        </button>
                    </div>
                </div>
            </div>

            var donHang = ViewBag.DonHang;

            try
            {
                // Kiểm tra xem donHang có thuộc tính MaDonHang không và không rỗng
                if (donHang.GetType().GetProperty("MaDonHang") != null && !string.IsNullOrEmpty((string)donHang.GetType().GetProperty("MaDonHang").GetValue(donHang)))
                {
                    <div class="mt-5 p-4 border rounded shadow-sm" style="margin-top: 3rem !important; padding: 1.5rem !important; border: 1px solid #ced4da !important; border-radius: 0.25rem !important; box-shadow: 0 .125rem .25rem rgba(0,0,0,.075) !important;">
                        <h2 class="mb-3 text-success" style="margin-bottom: 1rem !important; color: #28a745 !important; display: flex; align-items: center;">
                            <i class="fas fa-check-circle" style="margin-right: 0.5rem;"></i> Thông Tin Đơn Hàng
                        </h2>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; margin-top: 1rem; min-width: 600px;">
                                <thead style="background-color: #f8f9fa;">
                                    <tr style="display: table-row;">
                                        <th style="padding: 0.75rem; border: 1px solid #dee2e6; text-align: left; font-weight: bold; color: #495057;">Mã Đơn Hàng</th>
                                        @*<th style="padding: 0.75rem; border: 1px solid #dee2e6; text-align: left; font-weight: bold; color: #495057;">Tên Người Gửi</th>*@
                                        <th style="padding: 0.75rem; border: 1px solid #dee2e6; text-align: left; font-weight: bold; color: #495057;">Tên Người Nhận</th>
                                        <th style="padding: 0.75rem; border: 1px solid #dee2e6; text-align: left; font-weight: bold; color: #495057;">Cảng Đích Đến</th>
                                        <th style="padding: 0.75rem; border: 1px solid #dee2e6; text-align: left; font-weight: bold; color: #495057;">Ngày Tạo</th>
                                        <th style="padding: 0.75rem; border: 1px solid #dee2e6; text-align: left; font-weight: bold; color: #495057;">Lưu Trữ</th>
                                        @if (donHang.GetType().GetProperty("NgayXuatCang") != null && donHang.GetType().GetProperty("NgayXuatCang").GetValue(donHang) != null)
                                        {
                                            <th style="padding: 0.75rem; border: 1px solid #dee2e6; text-align: left; font-weight: bold; color: #495057;">Ngày Xuất Cảng</th>
                                        }
                                        @if (donHang.GetType().GetProperty("NgayNhapCang") != null && donHang.GetType().GetProperty("NgayNhapCang").GetValue(donHang) != null)
                                        {
                                            <th style="padding: 0.75rem; border: 1px solid #dee2e6; text-align: left; font-weight: bold; color: #495057;">Ngày Nhập Cảng</th>
                                        }
                                        <th style="padding: 0.75rem; border: 1px solid #dee2e6; text-align: left; font-weight: bold; color: #495057;">Trạng Thái Đơn Hàng</th>
                                        <th style="padding: 0.75rem; border: 1px solid #dee2e6; text-align: left; font-weight: bold; color: #495057;">Thanh Toán</th>
                                        @if (donHang.GetType().GetProperty("TongTien") != null && !string.IsNullOrEmpty((string)donHang.GetType().GetProperty("TongTien").GetValue(donHang)))
                                        {
                                            <th style="padding: 0.75rem; border: 1px solid #dee2e6; text-align: left; font-weight: bold; color: #495057;">Tổng Tiền</th>
                                        }
                                        @if (donHang.GetType().GetProperty("MoTa") != null && !string.IsNullOrEmpty((string)donHang.GetType().GetProperty("MoTa").GetValue(donHang)))
                                        {
                                            <th style="padding: 0.75rem; border: 1px solid #dee2e6; text-align: left; font-weight: bold; color: #495057;">Mô Tả</th>
                                        }
                                    </tr>
                                </thead>
                                <tbody style="display: table-row-group;">
                                    <tr style="display: table-row;">
                                        <td style="padding: 0.75rem; border: 1px solid #dee2e6; color: #212529;">
                                            <span class="font-weight-bold" style="font-weight: bold !important;">@Html.Encode((string)donHang.GetType().GetProperty("MaDonHang").GetValue(donHang))</span>
                                        </td>
                                        @*<td style="padding: 0.75rem; border: 1px solid #dee2e6; color: #212529;">
                                                @Html.Encode((string)donHang.GetType().GetProperty("TenNguoiGui").GetValue(donHang))
                                            </td>*@
                                        <td style="padding: 0.75rem; border: 1px solid #dee2e6; color: #212529;">
                                            @((string)donHang.GetType().GetProperty("TenNguoiNhan").GetValue(donHang))
                                        </td>
                                        <td style="padding: 0.75rem; border: 1px solid #dee2e6; color: #212529;">
                                            @Html.Encode((string)donHang.GetType().GetProperty("CangDichDen").GetValue(donHang))
                                        </td>
                                        <td style="padding: 0.75rem; border: 1px solid #dee2e6; color: #212529;">
                                            @Html.Encode((string)donHang.GetType().GetProperty("NgayTaoDonHang").GetValue(donHang))
                                        </td>
                                        <td style="padding: 0.75rem; border: 1px solid #dee2e6; color: #212529;">
                                            <span class="badge badge-info" style="background-color: #17a2b8 !important; color: #fff !important; display: inline-block !important; padding: 0.25em 0.4em !important; font-size: 75% !important; font-weight: 700 !important; line-height: 1 !important; text-align: center !important; white-space: nowrap !important; border-radius: 0.25rem !important;">@Html.Encode((string)donHang.GetType().GetProperty("ThoiGianLuuTru").GetValue(donHang)) ngày</span>
                                        </td>
                                        @if (donHang.GetType().GetProperty("NgayXuatCang") != null && donHang.GetType().GetProperty("NgayXuatCang").GetValue(donHang) != null)
                                        {
                                            <td style="padding: 0.75rem; border: 1px solid #dee2e6; color: #212529;">
                                                @Html.Encode((string)donHang.GetType().GetProperty("NgayXuatCang").GetValue(donHang))
                                            </td>
                                        }
                                        @if (donHang.GetType().GetProperty("NgayNhapCang") != null && donHang.GetType().GetProperty("NgayNhapCang").GetValue(donHang) != null)
                                        {
                                            <td style="padding: 0.75rem; border: 1px solid #dee2e6; color: #212529;">
                                                @Html.Encode((string)donHang.GetType().GetProperty("NgayNhapCang").GetValue(donHang))
                                            </td>
                                        }
                                        <td style="padding: 0.75rem; border: 1px solid #dee2e6; color: #212529;">
                                            <span class="badge badge-warning" style="background-color: #ffc107 !important; color: #212529 !important; display: inline-block !important; padding: 0.25em 0.4em !important; font-size: 75% !important; font-weight: 700 !important; line-height: 1 !important; text-align: center !important; white-space: nowrap !important; border-radius: 0.25rem !important;">@((string)donHang.GetType().GetProperty("TrangThaiDonHang").GetValue(donHang))</span>
                                        </td>
                                        <td style="padding: 0.75rem; border: 1px solid #dee2e6; color: #212529;">
                                            <span class="badge badge-success" style="background-color: #28a745 !important; color: #fff !important; display: inline-block !important; padding: 0.25em 0.4em !important; font-size: 75% !important; font-weight: 700 !important; line-height: 1 !important; text-align: center !important; white-space: nowrap !important; border-radius: 0.25rem !important;">@((string)donHang.GetType().GetProperty("TrangThaiThanhToan").GetValue(donHang))</span>
                                        </td>
                                        @if (donHang.GetType().GetProperty("TongTien") != null && !string.IsNullOrEmpty((string)donHang.GetType().GetProperty("TongTien").GetValue(donHang)))
                                        {
                                            <td style="padding: 0.75rem; border: 1px solid #dee2e6; color: #dc3545;">
                                                <span class="font-weight-bold text-danger" style="font-weight: bold !important;">@Html.Encode((string)donHang.GetType().GetProperty("TongTien").GetValue(donHang)) VNĐ</span>
                                            </td>
                                        }
                                        @if (donHang.GetType().GetProperty("MoTa") != null && !string.IsNullOrEmpty((string)donHang.GetType().GetProperty("MoTa").GetValue(donHang)))
                                        {
                                            <td style="padding: 0.75rem; border: 1px solid #dee2e6; color: #212529;">
                                                @((string)donHang.GetType().GetProperty("MoTa").GetValue(donHang))
                                            </td>
                                        }
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                }
                else
                {
                    <div class="alert alert-danger mt-4" role="alert" style="margin-top: 1.5rem !important; background-color: #f8d7da !important; border-color: #f5c6cb !important; color: #721c24 !important; padding: 0.75rem 1.25rem !important; border: 1px solid transparent !important; border-radius: 0.25rem !important;">
                        <i class="fas fa-exclamation-triangle" style="margin-right: 0.5rem;"></i> Dữ liệu đơn hàng không hợp lệ (thiếu MaDonHang).
                    </div>
                }
            }
            catch (Exception ex)
            {
                <div class="alert alert-danger mt-4" role="alert" style="margin-top: 1.5rem !important; background-color: #f8d7da !important; border-color: #f5c6cb !important; color: #721c24 !important; padding: 0.75rem 1.25rem !important; border: 1px solid transparent !important; border-radius: 0.25rem !important;">
                    <i class="fas fa-exclamation-triangle" style="margin-right: 0.5rem;"></i> Lỗi khi hiển thị thông tin đơn hàng: @((string)(ex.Message))
                </div>
            }
        }
        else
        {
            <div class="alert alert-danger mt-4" role="alert" style="margin-top: 1.5rem !important; background-color: #f8d7da !important; border-color: #f5c6cb !important; color: #721c24 !important; padding: 0.75rem 1.25rem !important; border: 1px solid transparent !important; border-radius: 0.25rem !important;">
                <i class="fas fa-exclamation-triangle" style="margin-right: 0.5rem;"></i> Không có dữ liệu đơn hàng để hiển thị.
            </div>
        }
    </div>
</main>

@section Scripts {
    <script type="text/javascript">
        $(document).ready(function () {
            $("#btnTraCuuTiepTheo").click(function () {
                var maDonHangTiepTheo = $("#maDonHangTiepTheo").val();
                if (maDonHangTiepTheo.trim() === "") {
                    alert("Vui lòng nhập Mã Đơn Hàng.");
                    return;
                }
                // Kiểm tra định dạng mã đơn hàng
                if (!/^[a-zA-Z0-9-]+$/.test(maDonHangTiepTheo)) {
                    alert("Mã đơn hàng chỉ chứa chữ cái, số và dấu gạch ngang.");
                    return;
                }
                window.location.href = '@Url.Action("KhachVangLai_TraCuuDonHang", "Home")?maDonHang=' + encodeURIComponent(maDonHangTiepTheo);
            });
        });
    </script>
}