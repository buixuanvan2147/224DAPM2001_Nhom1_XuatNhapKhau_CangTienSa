@{
    ViewBag.Title = "Tra Cứu Đơn Hàng";
}

<main style="min-height: calc(100vh - 160px); padding-top:0; margin-bottom: 50px;">
    <div class="container mt-5" style="margin-top: 3rem !important;">
        <div class="mt-4 p-4 border rounded shadow-sm" style="margin-top: 1.5rem !important; padding: 1.5rem !important; border: 1px solid #ced4da !important; border-radius: 0.25rem !important; box-shadow: 0 .125rem .25rem rgba(0,0,0,.075) !important;">
            <h2 style="margin-bottom: 1rem !important;">Tra Cứu Đơn Hàng Khác</h2>
            <div class="input-group" style="display: flex;">
                <input type="text" id="maDonHangTiepTheo" class="form-control border-light" style="padding: 15px; border-color: #ced4da !important; border-radius: 0.25rem 0 0 0.25rem; flex-grow: 1;" placeholder="Nhập Mã Đơn Hàng Khác">
                <div class="input-group-append" style="margin-left: 8px;">
                    <button id="btnTraCuuTiepTheo" class="btn btn-primary px-3" style="background-color: #007bff !important; border-color: #007bff !important; border-radius: 0 0.25rem 0.25rem 0; color: #fff; transition: background-color 0.15s ease-in-out, border-color 0.15s ease-in-out; display: flex; align-items: center;">
                        <i class="fas fa-search" style="margin-right: 0.3rem;"></i> Tra Cứu
                    </button>
                </div>
            </div>
        </div>
        @if (!string.IsNullOrEmpty(ViewBag.ErrorMessage))
        {
            <div class="alert alert-danger mt-4" role="alert" style="margin-top: 1.5rem !important; background-color: #f8d7da !important; border-color: #f5c6cb !important; color: #721c24 !important; padding: 0.75rem 1.25rem !important; border: 1px solid transparent !important; border-radius: 0.25rem !important; display: flex; align-items: center;">
                <i class="fas fa-exclamation-triangle" style="margin-right: 0.5rem;"></i> @((string)(ViewBag.ErrorMessage))
            </div>
        }

        @if (ViewBag.DonHang != null)
        {


            var donHang = ViewBag.DonHang;

            try
            {
                if (donHang.GetType().GetProperty("MaDonHang") != null && !string.IsNullOrEmpty((string)donHang.GetType().GetProperty("MaDonHang").GetValue(donHang)))
                {
                    <div class="mt-5 p-4 border rounded shadow-sm" style="margin-top: 3rem !important; padding: 1.5rem !important; border: 1px solid #ced4da !important; border-radius: 0.25rem !important; box-shadow: 0 .125rem .25rem rgba(0,0,0,.075) !important;">
                        <h2 class="mb-3 text-success" style="margin-bottom: 1rem !important; color: #28a745 !important; display: flex; align-items: center;">
                            <i class="fas fa-check-circle" style="margin-right: 0.5rem;"></i> Thông Tin Đơn Hàng
                        </h2>
                        <div style="overflow-x: auto;">
                            <table class="custom-table" style="width: 100%; border-collapse: collapse; margin-top: 1rem; min-width: 600px;">
                                <thead style="background-color: #e9ecef;">
                                    <tr style="display: table-row;">
                                        <th style="padding: 0.75rem; border: 1px solid #dee2e6; text-align: left; font-weight: bold; color: #343a40; white-space: nowrap;">Mã Đơn Hàng</th>
                                        <th style="padding: 0.75rem; border: 1px solid #dee2e6; text-align: left; font-weight: bold; color: #343a40; white-space: nowrap;">Tên Người Nhận</th>
                                        <th style="padding: 0.75rem; border: 1px solid #dee2e6; text-align: left; font-weight: bold; color: #343a40; white-space: nowrap;">Cảng Đích Đến</th>
                                        <th style="padding: 0.75rem; border: 1px solid #dee2e6; text-align: left; font-weight: bold; color: #343a40; white-space: nowrap;">Ngày Tạo</th>
                                        <th style="padding: 0.75rem; border: 1px solid #dee2e6; text-align: left; font-weight: bold; color: #343a40; white-space: nowrap;">Lưu Trữ</th>
                                        @if (donHang.GetType().GetProperty("NgayXuatCang") != null && donHang.GetType().GetProperty("NgayXuatCang").GetValue(donHang) != null)
                                        {
                                            <th style="padding: 0.75rem; border: 1px solid #dee2e6; text-align: left; font-weight: bold; color: #343a40; white-space: nowrap;">Ngày Xuất Cảng</th>
                                        }
                                        @if (donHang.GetType().GetProperty("NgayNhapCang") != null && donHang.GetType().GetProperty("NgayNhapCang").GetValue(donHang) != null)
                                        {
                                            <th style="padding: 0.75rem; border: 1px solid #dee2e6; text-align: left; font-weight: bold; color: #343a40; white-space: nowrap;">Ngày Nhập Cảng</th>
                                        }
                                        <th style="padding: 0.75rem; border: 1px solid #dee2e6; text-align: left; font-weight: bold; color: #343a40; white-space: nowrap;">Trạng Thái Đơn Hàng</th>
                                        <th style="padding: 0.75rem; border: 1px solid #dee2e6; text-align: left; font-weight: bold; color: #343a40; white-space: nowrap;">Thanh Toán</th>
                                        @if (donHang.GetType().GetProperty("TongTien") != null && !string.IsNullOrEmpty((string)donHang.GetType().GetProperty("TongTien").GetValue(donHang)))
                                        {
                                            <th style="padding: 0.75rem; border: 1px solid #dee2e6; text-align: left; font-weight: bold; color: #343a40; white-space: nowrap;">Tổng Tiền</th>
                                        }
                                        @if (donHang.GetType().GetProperty("MoTa") != null && !string.IsNullOrEmpty((string)donHang.GetType().GetProperty("MoTa").GetValue(donHang)))
                                        {
                                            <th style="padding: 0.75rem; border: 1px solid #dee2e6; text-align: left; font-weight: bold; color: #343a40; white-space: nowrap;">Mô Tả</th>
                                        }
                                    </tr>
                                </thead>
                                <tbody style="display: table-row-group;">
                                    <tr style="display: table-row;">
                                        <td style="padding: 0.75rem; border: 1px solid #dee2e6; color: #212529;">
                                            <span id="maDonHangDeHienThiCTDH" class="font-weight-bold" style="font-weight: bold !important;">@Html.Encode((string)donHang.GetType().GetProperty("MaDonHang").GetValue(donHang))</span>
                                        </td>
                                        <td style="padding: 0.75rem; border: 1px solid #dee2e6; color: #212529;">
                                            @((string)donHang.GetType().GetProperty("TenNguoiNhan").GetValue(donHang))
                                        </td>
                                        <td style="padding: 0.75rem; border: 1px solid #dee2e6; color: #212529;">
                                            @Html.Encode((string)donHang.GetType().GetProperty("CangDichDen").GetValue(donHang))
                                        </td>
                                        <td style="padding: 0.75rem; border: 1px solid #dee2e6; color: #212529;">
                                            @Html.Encode((string)donHang.GetType().GetProperty("NgayTaoDonHang").GetValue(donHang))
                                        </td>
                                        <td style="padding: 0.75rem; border: 1px solid #dee2e6; color: #212529;">
                                            <span class="badge badge-info" style="background-color: #17a2b8 !important; color: #fff !important; display: inline-block !important; padding: 0.25em 0.4em !important; font-size: 75% !important; font-weight: 700 !important; line-height: 1 !important; text-align: center !important; white-space: nowrap !important; border-radius: 0.25rem !important;">@Html.Encode((string)donHang.GetType().GetProperty("ThoiGianLuuTru").GetValue(donHang)) ngày</span>
                                        </td>
                                        @if (donHang.GetType().GetProperty("NgayXuatCang") != null && donHang.GetType().GetProperty("NgayXuatCang").GetValue(donHang) != null)
                                        {
                                            <td style="padding: 0.75rem; border: 1px solid #dee2e6; color: #212529;">
                                                @Html.Encode((string)donHang.GetType().GetProperty("NgayXuatCang").GetValue(donHang))
                                            </td>
                                        }
                                        @if (donHang.GetType().GetProperty("NgayNhapCang") != null && donHang.GetType().GetProperty("NgayNhapCang").GetValue(donHang) != null)
                                        {
                                            <td style="padding: 0.75rem; border: 1px solid #dee2e6; color: #212529;">
                                                @Html.Encode((string)donHang.GetType().GetProperty("NgayNhapCang").GetValue(donHang))
                                            </td>
                                        }
                                        <td style="padding: 0.75rem; border: 1px solid #dee2e6; color: #212529;">
                                            <span class="badge badge-warning" style="background-color: #ffc107 !important; color: #212529 !important; display: inline-block !important; padding: 0.25em 0.4em !important; font-size: 75% !important; font-weight: 700 !important; line-height: 1 !important; text-align: center !important; white-space: nowrap !important; border-radius: 0.25rem !important;">@((string)donHang.GetType().GetProperty("TrangThaiDonHang").GetValue(donHang))</span>
                                        </td>
                                        <td style="padding: 0.75rem; border: 1px solid #dee2e6; color: #212529;">
                                            <span class="badge badge-success" style="background-color: #28a745 !important; color: #fff !important; display: inline-block !important; padding: 0.25em 0.4em !important; font-size: 75% !important; font-weight: 700 !important; line-height: 1 !important; text-align: center !important; white-space: nowrap !important; border-radius: 0.25rem !important;">@((string)donHang.GetType().GetProperty("TrangThaiThanhToan").GetValue(donHang))</span>
                                        </td>
                                        @if (donHang.GetType().GetProperty("TongTien") != null && !string.IsNullOrEmpty((string)donHang.GetType().GetProperty("TongTien").GetValue(donHang)))
                                        {
                                            <td style="padding: 0.75rem; border: 1px solid #dee2e6; color: #dc3545;">
                                                <span class="font-weight-bold text-danger" style="font-weight: bold !important;">@Html.Encode((string)donHang.GetType().GetProperty("TongTien").GetValue(donHang)) VNĐ</span>
                                            </td>
                                        }
                                        @if (donHang.GetType().GetProperty("MoTa") != null && !string.IsNullOrEmpty((string)donHang.GetType().GetProperty("MoTa").GetValue(donHang)))
                                        {
                                            <td style="padding: 0.75rem; border: 1px solid #dee2e6; color: #212529;">
                                                @((string)donHang.GetType().GetProperty("MoTa").GetValue(donHang))
                                            </td>
                                        }
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="mt-5 p-4 border rounded shadow-sm" style="margin-top: 3rem !important; padding: 1.5rem !important; border: 1px solid #ced4da !important; border-radius: 0.25rem !important; box-shadow: 0 .125rem .25rem rgba(0,0,0,.075) !important;">
                        <h2 class="mb-3 text-success" style="margin-bottom: 1rem !important; color: #28a745 !important; display: flex; align-items: center;">
                            <i class="fas fa-check-circle" style="margin-right: 0.5rem;"></i> Chi Tiết Đơn Hàng
                        </h2>
                        <div style="overflow-x: auto;">
                            <table class="custom-table" style="width: 100%; border-collapse: collapse; margin-top: 1rem; min-width: 600px;">
                                <thead style="background-color: #e9ecef;">
                                    <tr>
                                        <th style="padding: 0.75rem; border: 1px solid #dee2e6; text-align: left; font-weight: bold; color: #343a40; white-space: nowrap;">Mã Đơn Hàng</th>
                                        <th style="padding: 0.75rem; border: 1px solid #dee2e6; text-align: left; font-weight: bold; color: #343a40; white-space: nowrap;">Tên Danh Mục</th>
                                        <th style="padding: 0.75rem; border: 1px solid #dee2e6; text-align: left; font-weight: bold; color: #343a40; white-space: nowrap;">Tên Hàng Hóa</th>
                                        <th style="padding: 0.75rem; border: 1px solid #dee2e6; text-align: left; font-weight: bold; color: #343a40; white-space: nowrap;">Số Lượng</th>
                                        <th style="padding: 0.75rem; border: 1px solid #dee2e6; text-align: left; font-weight: bold; color: #343a40; white-space: nowrap;">Chất Lượng</th>
                                        <th style="padding: 0.75rem; border: 1px solid #dee2e6; text-align: left; font-weight: bold; color: #343a40; white-space: nowrap;">Đơn Vị Tính</th>
                                        <th style="padding: 0.75rem; border: 1px solid #dee2e6; text-align: left; font-weight: bold; color: #343a40; white-space: nowrap;">Đơn Giá</th>
                                        <th style="padding: 0.75rem; border: 1px solid #dee2e6; text-align: left; font-weight: bold; color: #343a40; white-space: nowrap;">Tiền Lưu Kho</th>
                                        <th style="padding: 0.75rem; border: 1px solid #dee2e6; text-align: left; font-weight: bold; color: #343a40; white-space: nowrap;">Mô Tả</th>
                                    </tr>
                                </thead>
                                <tbody id="orderDetailsBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                }
                else
                {
                    <div class="alert alert-danger mt-4" role="alert" style="margin-top: 1.5rem !important; background-color: #f8d7da !important; border-color: #f5c6cb !important; color: #721c24 !important; padding: 0.75rem 1.25rem !important; border: 1px solid transparent !important; border-radius: 0.25rem !important;">
                        <i class="fas fa-exclamation-triangle" style="margin-right: 0.5rem;"></i> Dữ liệu đơn hàng không hợp lệ (thiếu MaDonHang).
                    </div>
                }
            }
            catch (Exception ex)
            {
                <div class="alert alert-danger mt-4" role="alert" style="margin-top: 1.5rem !important; background-color: #f8d7da !important; border-color: #f5c6cb !important; color: #721c24 !important; padding: 0.75rem 1.25rem !important; border: 1px solid transparent !important; border-radius: 0.25rem !important;">
                    <i class="fas fa-exclamation-triangle" style="margin-right: 0.5rem;"></i> Lỗi khi hiển thị thông tin đơn hàng: @((string)(ex.Message))
                </div>
            }
        }
        else
        {
            <div class="alert alert-danger mt-4" role="alert" style="margin-top: 1.5rem !important; background-color: #f8d7da !important; border-color: #f5c6cb !important; color: #721c24 !important; padding: 0.75rem 1.25rem !important; border: 1px solid transparent !important; border-radius: 0.25rem !important;">
                <i class="fas fa-exclamation-triangle" style="margin-right: 0.5rem;"></i> Không có dữ liệu đơn hàng để hiển thị.
            </div>
        }
    </div>
</main>

<style>
    .custom-table {
        border-collapse: collapse;
        width: 100%;
        min-width: 600px;
        margin-top: 1rem;
    }

        .custom-table thead {
            background-color: #e9ecef; /* Màu nền nhẹ nhàng cho tiêu đề */
        }

        .custom-table th {
            padding: 0.75rem;
            border: 1px solid #dee2e6;
            text-align: left;
            font-weight: bold;
            color: #343a40; /* Màu chữ đậm cho tiêu đề */
            white-space: nowrap; /* Ngăn tiêu đề xuống dòng */
            background-color: #e9ecef; /* Đảm bảo màu nền đồng nhất */
        }

        .custom-table td {
            padding: 0.75rem;
            border: 1px solid #dee2e6;
            color: #212529; /* Màu chữ đồng bộ cho dữ liệu */
        }

        .custom-table tr:hover {
            background-color: #f1f1f1; /* Hiệu ứng hover nhẹ nhàng */
        }

    /* Đảm bảo badge giữ nguyên phong cách */
    .badge {
        display: inline-block;
        padding: 0.25em 0.4em;
        font-size: 75%;
        font-weight: 700;
        line-height: 1;
        text-align: center;
        white-space: nowrap;
        border-radius: 0.25rem;
    }

    /* Giữ nguyên màu sắc đặc biệt cho một số cột */
    .text-danger {
        color: #dc3545 !important;
    }

    .badge-info {
        background-color: #17a2b8 !important;
        color: #fff !important;
    }

    .badge-warning {
        background-color: #ffc107 !important;
        color: #212529 !important;
    }

    .badge-success {
        background-color: #28a745 !important;
        color: #fff !important;
    }
</style>

@section Scripts {
    <script type="text/javascript">
        $(document).ready(function () {
            $("#btnTraCuuTiepTheo").click(function () {
                var maDonHangTiepTheo = $("#maDonHangTiepTheo").val();
                if (maDonHangTiepTheo.trim() === "") {
                    alert("Vui lòng nhập Mã Đơn Hàng.");
                    return;
                }
                if (!/^[a-zA-Z0-9-]+$/.test(maDonHangTiepTheo)) {
                    alert("Mã đơn hàng chỉ chứa chữ cái, số và dấu gạch ngang.");
                    return;
                }
                window.location.href = '@Url.Action("KhachVangLai_TraCuuDonHang", "Home")?maDonHang=' + encodeURIComponent(maDonHangTiepTheo);
            });

            var maDonHangCTDH = $("#maDonHangDeHienThiCTDH").text().trim();
            if (maDonHangCTDH && maDonHangCTDH.trim() !== "") {
                console.log("Đang tải chi tiết đơn hàng cho maDonHang: " + maDonHangCTDH);
                $.ajax({
                    url: '@Url.Action("GetOrderDetails", "Home")',
                    type: 'GET',
                    data: { maDonHang: maDonHangCTDH },
                    success: function (data) {
                        var orderDetailsBody = $('#orderDetailsBody');
                        orderDetailsBody.empty();
                        if (data.success) {
                            if (data.orderDetails.length === 0) {
                                orderDetailsBody.append('<tr><td colspan="9" style="padding: 0.75rem; text-align: center;">Không có chi tiết đơn hàng.</td></tr>');
                            } else {
                                $.each(data.orderDetails, function (index, item) {
                                    var row = $('<tr style="display: table-row;"></tr>');
                                    row.append('<td style="padding: 0.75rem; border: 1px solid #dee2e6; color: #212529;">' + (item.maDonHang || "") + '</td>');
                                    row.append('<td style="padding: 0.75rem; border: 1px solid #dee2e6; color: #212529;">' + (item.tenDMHH || "") + '</td>');
                                    row.append('<td style="padding: 0.75rem; border: 1px solid #dee2e6; color: #212529;">' + (item.tenHH || "") + '</td>');
                                    row.append('<td style="padding: 0.75rem; border: 1px solid #dee2e6; color: #212529;">' + (item.soLuong || 0) + '</td>');
                                    row.append('<td style="padding: 0.75rem; border: 1px solid #dee2e6; color: #212529;">' + (item.chatLuong || "") + '</td>');
                                    row.append('<td style="padding: 0.75rem; border: 1px solid #dee2e6; color: #212529;">' + (item.donViTinh || "") + '</td>');
                                    row.append('<td style="padding: 0.75rem; border: 1px solid #dee2e6; color: #212529;">' + (item.donGia || 0) + '</td>');
                                    row.append('<td style="padding: 0.75rem; border: 1px solid #dee2e6; color: #212529;">' + (item.tienLuuKho || "") + '</td>');
                                    row.append('<td style="padding: 0.75rem; border: 1px solid #dee2e6; color: #212529;">' + (item.moTa || "") + '</td>');
                                    orderDetailsBody.append(row);
                                });
                            }
                        } else {
                            orderDetailsBody.append('<tr><td colspan="9" style="padding: 0.75rem; text-align: center;">' + (data.message || "Không thể lấy chi tiết đơn hàng.") + '</td></tr>');
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Lỗi AJAX:', status, error);
                        $('#orderDetailsBody').empty().append('<tr><td colspan="9" style="padding: 0.75rem; text-align: center;">Đã xảy ra lỗi khi lấy chi tiết đơn hàng.</td></tr>');
                    }
                });
            } else {
                console.warn('Không có mã đơn hàng để tải chi tiết đơn hàng.');
                $('#orderDetailsBody').empty().append('<tr><td colspan="9" style="padding: 0.75rem; text-align: center;">Không có mã đơn hàng để hiển thị chi tiết.</td></tr>');
            }
        });
    </script>
}